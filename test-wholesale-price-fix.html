<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Wholesale Price Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #333;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .test-result {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
        .success {
            color: #388e3c;
            font-weight: bold;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #45a049;
        }
        .test-steps {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <h1>Test Wholesale Price Fix</h1>

    <div class="test-section">
        <h2>Test 1: Context-Based Wholesale Behavior</h2>
        <p>This test verifies that products behave differently based on which page they're added from.</p>

        <div class="test-steps">
            <h3>Test Steps:</h3>
            <ol>
                <li>Add a product from the New Arrivals section (should behave as regular product)</li>
                <li>Add the same product from the Wholesale page (should behave as wholesale product)</li>
                <li>Verify that only the item added from wholesale page shows MOQ restrictions</li>
                <li>Verify that the item added from New Arrivals can be adjusted freely</li>
            </ol>
        </div>

        <button onclick="runContextBasedTest()">Run Context-Based Test</button>
        <div id="contextTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Price Rounding Fix</h2>
        <p>This test verifies that wholesale prices are no longer incorrectly rounded down.</p>

        <div class="test-steps">
            <h3>Test Steps:</h3>
            <ol>
                <li>Add a product with wholesale price of 100 cedis</li>
                <li>Verify that the price displays as 100 cedis (not 99 cedis)</li>
                <li>Check that the price calculation is correct</li>
            </ol>
        </div>

        <button onclick="runPriceRoundingTest()">Run Price Rounding Test</button>
        <div id="priceTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Cart Display Logic</h2>
        <p>This test verifies that wholesale indicators are only shown for items added from the wholesale page.</p>

        <div class="test-steps">
            <h3>Test Steps:</h3>
            <ol>
                <li>Add multiple products from different pages</li>
                <li>Verify that only items added from wholesale page show wholesale indicators</li>
                <li>Verify that regular items don't show MOQ restrictions</li>
            </ol>
        </div>

        <button onclick="runCartDisplayTest()">Run Cart Display Test</button>
        <div id="cartDisplayTestResult" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Quantity Update Logic</h2>
        <p>This test verifies that quantity updates respect the source page context.</p>

        <div class="test-steps">
            <h3>Test Steps:</h3>
            <ol>
                <li>Add a wholesale product from wholesale page</li>
                <li>Add the same product from a regular page</li>
                <li>Try to reduce quantity below MOQ for each</li>
                <li>Verify that only the wholesale page item enforces MOQ</li>
            </ol>
        </div>

        <button onclick="runQuantityUpdateTest()">Run Quantity Update Test</button>
        <div id="quantityTestResult" class="test-result"></div>
    </div>

    <script>
        // Mock cart for testing
        let testCart = [];

        function runContextBasedTest() {
            const resultDiv = document.getElementById('contextTestResult');
            resultDiv.innerHTML = 'Running context-based test...<br>';

            // Simulate adding product from New Arrivals (sourcePage = null)
            const productId = 'test-product-1';
            const product = {
                id: productId,
                name: 'Test Product',
                price: 100,
                wholesalePrice: 90,
                isWholesale: true,
                moq: 5
            };

            // Add from New Arrivals (sourcePage = null)
            const newArrivalsItem = {
                id: productId,
                name: product.name,
                price: product.price, // Should use regular price
                quantity: 1,
                isWholesale: false, // Should be false because sourcePage is null
                sourcePage: null
            };

            // Add from Wholesale page (sourcePage = 'wholesale')
            const wholesaleItem = {
                id: productId,
                name: product.name,
                price: product.wholesalePrice, // Should use wholesale price
                quantity: 5, // Should be MOQ
                isWholesale: true,
                moq: product.moq,
                sourcePage: 'wholesale'
            };

            testCart = [newArrivalsItem, wholesaleItem];

            // Verify the behavior
            let success = true;
            let messages = [];

            // Check New Arrivals item
            if (newArrivalsItem.isWholesale === false && newArrivalsItem.sourcePage === null) {
                messages.push('<span class="success">✓ New Arrivals item correctly treated as regular product</span>');
            } else {
                messages.push('<span class="error">✗ New Arrivals item incorrectly treated as wholesale</span>');
                success = false;
            }

            // Check Wholesale item
            if (wholesaleItem.isWholesale === true && wholesaleItem.sourcePage === 'wholesale' && wholesaleItem.moq === 5) {
                messages.push('<span class="success">✓ Wholesale item correctly treated as wholesale with MOQ</span>');
            } else {
                messages.push('<span class="error">✗ Wholesale item not properly configured</span>');
                success = false;
            }

            // Check prices
            if (newArrivalsItem.price === 100 && wholesaleItem.price === 90) {
                messages.push('<span class="success">✓ Prices correctly set based on context</span>');
            } else {
                messages.push('<span class="error">✗ Prices not correctly set</span>');
                success = false;
            }

            resultDiv.innerHTML += messages.join('<br>');
            resultDiv.innerHTML += success ? '<br><span class="success">Context-based test PASSED!</span>' : '<br><span class="error">Context-based test FAILED!</span>';
        }

        function runPriceRoundingTest() {
            const resultDiv = document.getElementById('priceTestResult');
            resultDiv.innerHTML = 'Running price rounding test...<br>';

            // Test the price rounding fix
            const wholesalePrice = 100;
            const roundedPrice = Math.round(wholesalePrice); // This should be 100, not 99

            let success = true;
            let messages = [];

            if (roundedPrice === 100) {
                messages.push('<span class="success">✓ Price correctly rounded to 100 cedis</span>');
            } else {
                messages.push(`<span class="error">✗ Price incorrectly rounded to ${roundedPrice} cedis</span>`);
                success = false;
            }

            // Test that we're not using Math.round() on wholesale prices in the display
            const displayPrice = wholesalePrice.toLocaleString();
            if (displayPrice === '100') {
                messages.push('<span class="success">✓ Price correctly displayed as 100 cedis</span>');
            } else {
                messages.push(`<span class="error">✗ Price incorrectly displayed as ${displayPrice}</span>`);
                success = false;
            }

            resultDiv.innerHTML += messages.join('<br>');
            resultDiv.innerHTML += success ? '<br><span class="success">Price rounding test PASSED!</span>' : '<br><span class="error">Price rounding test FAILED!</span>';
        }

        function runCartDisplayTest() {
            const resultDiv = document.getElementById('cartDisplayTestResult');
            resultDiv.innerHTML = 'Running cart display test...<br>';

            // Create test cart items
            const regularItem = {
                id: 'regular-1',
                name: 'Regular Product',
                price: 100,
                quantity: 2,
                isWholesale: false,
                sourcePage: null
            };

            const wholesaleItem = {
                id: 'wholesale-1',
                name: 'Wholesale Product',
                price: 90,
                quantity: 5,
                isWholesale: true,
                moq: 5,
                sourcePage: 'wholesale'
            };

            const mixedItem = {
                id: 'mixed-1',
                name: 'Mixed Product',
                price: 95,
                quantity: 3,
                isWholesale: true, // Product is wholesale but added from regular page
                sourcePage: null
            };

            testCart = [regularItem, wholesaleItem, mixedItem];

            let success = true;
            let messages = [];

            // Test each item
            testCart.forEach(item => {
                const showWholesaleIndicators = item.isWholesale && item.sourcePage === 'wholesale';

                if (item.id === 'regular-1' && !showWholesaleIndicators) {
                    messages.push('<span class="success">✓ Regular item correctly shows no wholesale indicators</span>');
                } else if (item.id === 'wholesale-1' && showWholesaleIndicators) {
                    messages.push('<span class="success">✓ Wholesale item correctly shows wholesale indicators</span>');
                } else if (item.id === 'mixed-1' && !showWholesaleIndicators) {
                    messages.push('<span class="success">✓ Mixed item (wholesale product from regular page) correctly shows no wholesale indicators</span>');
                } else {
                    messages.push(`<span class="error">✗ Item ${item.id} incorrectly shows/hides wholesale indicators</span>`);
                    success = false;
                }
            });

            resultDiv.innerHTML += messages.join('<br>');
            resultDiv.innerHTML += success ? '<br><span class="success">Cart display test PASSED!</span>' : '<br><span class="error">Cart display test FAILED!</span>';
        }

        function runQuantityUpdateTest() {
            const resultDiv = document.getElementById('quantityTestResult');
            resultDiv.innerHTML = 'Running quantity update test...<br>';

            // Create test cart items
            const wholesaleItem = {
                id: 'wholesale-1',
                name: 'Wholesale Product',
                price: 90,
                quantity: 5,
                isWholesale: true,
                moq: 5,
                sourcePage: 'wholesale'
            };

            const regularItem = {
                id: 'regular-1',
                name: 'Regular Product',
                price: 100,
                quantity: 2,
                isWholesale: true, // Product is wholesale but added from regular page
                sourcePage: null
            };

            testCart = [wholesaleItem, regularItem];

            let success = true;
            let messages = [];

            // Test quantity reduction for wholesale item (should fail)
            const wholesaleCanReduce = !(wholesaleItem.isWholesale && wholesaleItem.sourcePage === 'wholesale') || (wholesaleItem.isWholesale && wholesaleItem.quantity > wholesaleItem.moq);

            if (!wholesaleCanReduce) {
                messages.push('<span class="success">✓ Wholesale item correctly prevents quantity reduction below MOQ</span>');
            } else {
                messages.push('<span class="error">✗ Wholesale item incorrectly allows quantity reduction below MOQ</span>');
                success = false;
            }

            // Test quantity reduction for regular item (should succeed)
            const regularCanReduce = !(regularItem.isWholesale && regularItem.sourcePage === 'wholesale') || (regularItem.isWholesale && regularItem.quantity > (regularItem.moq || 1));

            if (regularCanReduce) {
                messages.push('<span class="success">✓ Regular item correctly allows quantity reduction</span>');
            } else {
                messages.push('<span class="error">✗ Regular item incorrectly prevents quantity reduction</span>');
                success = false;
            }

            resultDiv.innerHTML += messages.join('<br>');
            resultDiv.innerHTML += success ? '<br><span class="success">Quantity update test PASSED!</span>' : '<br><span class="error">Quantity update test FAILED!</span>';
        }
    </script>
</body>
</html>