<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Wholesale Quantity Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Test Wholesale Quantity Fix</h1>

    <div class="test-section">
        <h2>Test 1: Add Wholesale Product to Cart</h2>
        <p>This test adds a wholesale product to cart and verifies it has the correct sourcePage property.</p>
        <button onclick="testAddWholesaleProduct()">Run Test</button>
        <div id="test1Result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Attempt to Reduce Quantity Below MOQ</h2>
        <p>This test attempts to reduce quantity below MOQ and verifies it's prevented.</p>
        <button onclick="testReduceQuantityBelowMOQ()">Run Test</button>
        <div id="test2Result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Attempt to Reduce Quantity Above MOQ</h2>
        <p>This test attempts to reduce quantity when it's still above MOQ and verifies it's allowed.</p>
        <button onclick="testReduceQuantityAboveMOQ()">Run Test</button>
        <div id="test3Result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Add Regular Product and Verify No Restrictions</h2>
        <p>This test adds a regular product and verifies no MOQ restrictions apply.</p>
        <button onclick="testRegularProductNoRestrictions()">Run Test</button>
        <div id="test4Result" class="test-result"></div>
    </div>

    <script>
        // Mock product data for testing
        const mockProducts = {
            'wholesale-product-1': {
                id: 'wholesale-product-1',
                name: 'Wholesale Test Product',
                price: 100,
                wholesalePrice: 90,
                image: 'test.jpg',
                isWholesale: true,
                moq: 5,
                minOrderQty: 5,
                inStock: true,
                stockCount: 100
            },
            'regular-product-1': {
                id: 'regular-product-1',
                name: 'Regular Test Product',
                price: 50,
                image: 'test.jpg',
                isWholesale: false,
                inStock: true,
                stockCount: 100
            }
        };

        // Mock getProductById function
        function getProductById(productId) {
            return Promise.resolve(mockProducts[productId]);
        }

        // Test functions
        async function testAddWholesaleProduct() {
            const resultDiv = document.getElementById('test1Result');
            resultDiv.innerHTML = 'Running test...';

            try {
                // Clear cart first
                localStorage.removeItem('cart');

                // Add wholesale product
                await addWholesaleToCart('wholesale-product-1', 10);

                // Get cart from localStorage
                const cart = JSON.parse(localStorage.getItem('cart')) || [];

                if (cart.length === 0) {
                    resultDiv.innerHTML = '<span class="error">ERROR: Cart is empty after adding product</span>';
                    return;
                }

                const item = cart[0];

                if (!item.sourcePage) {
                    resultDiv.innerHTML = '<span class="error">ERROR: Item missing sourcePage property</span>';
                    return;
                }

                if (item.sourcePage !== 'wholesale') {
                    resultDiv.innerHTML = '<span class="error">ERROR: sourcePage is not "wholesale", it is: ' + item.sourcePage + '</span>';
                    return;
                }

                resultDiv.innerHTML = '<span class="success">SUCCESS: Wholesale product added with correct sourcePage property</span>';
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
            }
        }

        async function testReduceQuantityBelowMOQ() {
            const resultDiv = document.getElementById('test2Result');
            resultDiv.innerHTML = 'Running test...';

            try {
                // Clear cart first
                localStorage.removeItem('cart');

                // Add wholesale product with quantity exactly at MOQ
                await addWholesaleToCart('wholesale-product-1', 5);

                // Get cart from localStorage
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                let item = cart[0];

                // Try to reduce quantity below MOQ (to 4)
                updateCartQuantity('wholesale-product-1', 4);

                // Get updated cart
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                item = cart[0];

                if (item.quantity === 4) {
                    resultDiv.innerHTML = '<span class="error">ERROR: Quantity was reduced below MOQ (should be prevented)</span>';
                    return;
                }

                if (item.quantity === 5) {
                    resultDiv.innerHTML = '<span class="success">SUCCESS: Quantity reduction below MOQ was prevented</span>';
                    return;
                }

                resultDiv.innerHTML = '<span class="error">ERROR: Unexpected quantity: ' + item.quantity + '</span>';
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
            }
        }

        async function testReduceQuantityAboveMOQ() {
            const resultDiv = document.getElementById('test3Result');
            resultDiv.innerHTML = 'Running test...';

            try {
                // Clear cart first
                localStorage.removeItem('cart');

                // Add wholesale product with quantity above MOQ
                await addWholesaleToCart('wholesale-product-1', 10);

                // Get cart from localStorage
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                let item = cart[0];

                // Try to reduce quantity but keep it above MOQ (from 10 to 6)
                updateCartQuantity('wholesale-product-1', 6);

                // Get updated cart
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                item = cart[0];

                if (item.quantity === 6) {
                    resultDiv.innerHTML = '<span class="success">SUCCESS: Quantity reduction above MOQ was allowed</span>';
                    return;
                }

                resultDiv.innerHTML = '<span class="error">ERROR: Quantity reduction above MOQ was prevented (quantity is: ' + item.quantity + ')</span>';
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
            }
        }

        async function testRegularProductNoRestrictions() {
            const resultDiv = document.getElementById('test4Result');
            resultDiv.innerHTML = 'Running test...';

            try {
                // Clear cart first
                localStorage.removeItem('cart');

                // Add regular product
                await addToCart('regular-product-1', 3, null);

                // Get cart from localStorage
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                let item = cart[0];

                // Try to reduce quantity to 1
                updateCartQuantity('regular-product-1', 1);

                // Get updated cart
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                item = cart[0];

                if (item.quantity === 1) {
                    resultDiv.innerHTML = '<span class="success">SUCCESS: Regular product quantity reduction was allowed</span>';
                    return;
                }

                resultDiv.innerHTML = '<span class="error">ERROR: Regular product quantity reduction was prevented (quantity is: ' + item.quantity + ')</span>';
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">ERROR: ' + error.message + '</span>';
            }
        }

        // Include the necessary functions from script.js
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function showNotification(message, type = 'info') {
            console.log('Notification:', message, 'Type:', type);
        }

        async function addWholesaleToCart(productId, quantity = null) {
            try {
                console.log('addWholesaleToCart called with:', { productId, quantity });

                const product = await getProductById(productId);
                if (!product || !product.isWholesale) {
                    console.error('Product not found or not wholesale:', productId);
                    showNotification('Product not found or not a wholesale item.', 'error');
                    return;
                }

                console.log('Found product:', { name: product.name, isWholesale: product.isWholesale });

                const moq = product.moq || product.minOrderQty || 1;
                const addQuantity = quantity || moq;

                console.log('Quantity info:', { moq, addQuantity });

                // Validate quantity meets minimum order quantity
                if (addQuantity < moq) {
                    showNotification(`Minimum order quantity is ${moq}.`, 'error');
                    return;
                }

                const existingItem = cart.find(item => item.id === productId);

                if (existingItem) {
                    // For wholesale, add the specified quantity
                    const newQuantity = existingItem.quantity + addQuantity;

                    // Check inventory
                    const inventoryCheck = { available: product.inStock };

                    console.log('Inventory check for existing item:', inventoryCheck);

                    if (!inventoryCheck.available) {
                        showNotification(inventoryCheck.reason || 'Cannot add more items. Insufficient stock.', 'error');
                        return;
                    }

                    existingItem.quantity = newQuantity;
                    showNotification(`Added ${addQuantity} more ${product.name} to cart!`, 'success');
                } else {
                    // First time adding wholesale item

                    // Check inventory for the quantity
                    const inventoryCheck = { available: product.inStock };

                    console.log('Inventory check for new item:', inventoryCheck);

                    if (!inventoryCheck.available) {
                        showNotification(inventoryCheck.reason || 'Cannot add item. Insufficient stock.', 'error');
                        return;
                    }

                    cart.push({
                        id: productId,
                        name: product.name,
                        price: product.wholesalePrice || product.price,
                        image: product.image,
                        quantity: addQuantity,
                        isWholesale: true,
                        moq: moq,
                        sourcePage: 'wholesale' // Track that this item was added from wholesale page
                    });

                    showNotification(`${product.name} added to cart with quantity ${addQuantity}!`, 'success');
                }

                saveCart();
            } catch (error) {
                console.error('Error in addWholesaleToCart:', error);
                showNotification('Error adding item to cart. Please try again.', 'error');
            }
        }

        async function addToCart(productId, quantity = 1, sourcePage = null) {
            const product = await getProductById(productId);
            if (!product) {
                console.error('Product not found:', productId);
                showNotification('Product not found.', 'error');
                return;
            }

            // Debug logging for product wholesale status
            console.log('DEBUG: Product data for cart addition:', {
                productId: productId,
                productName: product.name,
                isWholesale: product.isWholesale,
                moq: product.moq,
                minOrderQty: product.minOrderQty,
                category: product.category,
                isNewArrival: product.isNewArrival,
                isFastSelling: product.isFastSelling,
                sourcePage: sourcePage
            });

            // Check inventory
            const inventoryCheck = { available: product.inStock };

            if (!inventoryCheck.available) {
                showNotification(inventoryCheck.reason || 'Product is out of stock.', 'error');
                return;
            }

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                const newQuantity = existingItem.quantity + quantity;
                // Check if new total exceeds available stock
                const stockCheck = { available: true };

                if (!stockCheck.available) {
                    showNotification('Cannot add more items. Insufficient stock.', 'error');
                    return;
                }
                existingItem.quantity = newQuantity;
            } else {
                // Determine if this should be treated as a wholesale purchase based on source page
                // If added from wholesale page, use wholesale attributes; otherwise treat as regular
                const isWholesalePurchase = sourcePage === 'wholesale';

                // Create cart item with context-aware wholesale behavior
                const cartItem = {
                    id: productId,
                    name: product.name,
                    price: isWholesalePurchase && product.wholesalePrice ? product.wholesalePrice : product.price,
                    image: product.image,
                    quantity: quantity,
                    isWholesale: isWholesalePurchase,
                    sourcePage: sourcePage // Track where this item was added from
                };

                // Only add MOQ for items treated as wholesale purchases
                if (isWholesalePurchase) {
                    cartItem.moq = product.moq || product.minOrderQty || 1;
                }

                // Debug logging for cart item creation
                console.log('DEBUG: Cart item being created:', {
                    productId: productId,
                    productName: product.name,
                    isWholesale: cartItem.isWholesale,
                    moq: cartItem.moq,
                    quantity: quantity,
                    sourcePage: cartItem.sourcePage,
                    priceUsed: cartItem.price
                });

                cart.push(cartItem);
            }

            saveCart();
            showNotification(`${product.name} added to cart!`, 'success');
        }

        function updateCartQuantity(productId, quantity) {
            console.log('DEBUG: updateCartQuantity called with:', { productId, quantity });

            const item = cart.find(item => item.id === productId);
            if (item) {
                console.log('DEBUG: Found cart item:', {
                    itemId: item.id,
                    itemName: item.name,
                    currentQuantity: item.quantity,
                    isWholesale: item.isWholesale,
                    moq: item.moq,
                    minOrderQty: item.minOrderQty,
                    sourcePage: item.sourcePage
                });

                if (quantity <= 0) {
                    // Remove item if quantity is 0 or less
                    cart = cart.filter(i => i.id !== productId);
                    saveCart();
                    return;
                }

                // Only apply MOQ restrictions to items that were added from wholesale page
                if (item.isWholesale === true && item.sourcePage === 'wholesale') {
                    const moq = item.moq || item.minOrderQty || 1;
                    console.log('DEBUG: Wholesale item (added from wholesale page) - checking MOQ:', { moq, quantity, currentQuantity: item.quantity });

                    // For wholesale items added from wholesale page, prevent quantity reduction below MOQ
                    if (quantity < moq) {
                        console.log('DEBUG: Wholesale item quantity reduction below MOQ attempted - preventing');
                        showNotification(`Cannot reduce quantity below minimum order quantity (${moq}) for wholesale items.`, 'warning');
                        return;
                    }
                } else {
                    console.log('DEBUG: Non-wholesale context item - allowing quantity change to:', quantity);
                }
                // For items not added from wholesale page, allow any quantity >= 1
                item.quantity = quantity;
                saveCart();
                console.log('DEBUG: Quantity updated successfully to:', quantity);
            } else {
                console.log('DEBUG: Cart item not found for productId:', productId);
            }
        }
    </script>
</body>
</html>